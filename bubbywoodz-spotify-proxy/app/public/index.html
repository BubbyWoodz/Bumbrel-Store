<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Proxy for Homepage</title>
    <style>
        :root {
            --primary: #1DB954;
            --dark: #191414;
            --light: #FFFFFF;
            --gray: #535353;
            --light-gray: #B3B3B3;
        }
        
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--dark);
            color: var(--light);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }
        
        header img {
            width: 50px;
            margin-right: 15px;
        }
        
        h1, h2, h3 {
            margin: 0;
            font-weight: 700;
        }
        
        .card {
            background-color: #121212;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: var(--light-gray);
        }
        
        input[type="text"], 
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--gray);
            background-color: #333;
            color: var(--light);
            font-size: 16px;
        }
        
        button {
            background-color: var(--primary);
            color: var(--light);
            border: none;
            border-radius: 30px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #1ed760;
        }
        
        .status {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-success {
            background-color: var(--primary);
        }
        
        .status-error {
            background-color: #e22134;
        }
        
        .status-message {
            font-size: 14px;
        }
        
        .now-playing {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        
        .now-playing img {
            width: 60px;
            height: 60px;
            border-radius: 4px;
            margin-right: 15px;
        }
        
        .track-info {
            flex-grow: 1;
        }
        
        .track-name {
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .artist-name {
            color: var(--light-gray);
            font-size: 14px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .control-button {
            background-color: transparent;
            color: var(--light);
            border: 1px solid var(--gray);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
            padding: 0;
            font-size: 18px;
        }
        
        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .homepage-config {
            background-color: #282828;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .tab-container {
            margin-bottom: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            color: var(--light-gray);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            color: var(--light-gray);
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Spotify_icon.svg/1982px-Spotify_icon.svg.png" alt="Spotify Logo">
            <h1>Spotify Proxy for Homepage</h1>
        </header>
        
        <div class="tab-container">
            <div class="tabs">
                <div class="tab active" data-tab="status">Status</div>
                <div class="tab" data-tab="config">Configuration</div>
                <div class="tab" data-tab="homepage">Homepage Setup</div>
            </div>
            
            <div class="tab-content active" id="status-tab">
                <div class="card">
                    <h2>Connection Status</h2>
                    <div class="status">
                        <div class="status-indicator" id="connection-indicator"></div>
                        <div class="status-message" id="connection-status">Checking connection...</div>
                    </div>
                    
                    <button id="test-connection" style="margin-top: 15px;">Test Connection</button>
                    
                    <div id="now-playing-container" style="display: none;">
                        <h3 style="margin-top: 20px;">Currently Playing</h3>
                        <div class="now-playing">
                            <img id="album-art" src="" alt="Album Art">
                            <div class="track-info">
                                <div class="track-name" id="track-name">Not Playing</div>
                                <div class="artist-name" id="artist-name"></div>
                            </div>
                        </div>
                        
                        <div class="controls">
                            <button class="control-button" id="prev-button">⏮</button>
                            <button class="control-button" id="play-pause-button">⏯</button>
                            <button class="control-button" id="next-button">⏭</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>API Status</h2>
                    <div id="last-api-call">Last API Call: Never</div>
                    <div class="status">
                        <div class="status-indicator" id="api-indicator"></div>
                        <div class="status-message" id="api-status">No API calls made yet</div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="config-tab">
                <div class="card">
                    <h2>Spotify API Configuration</h2>
                    <form id="config-form">
                        <div class="form-group">
                            <label for="client-id">Client ID</label>
                            <input type="text" id="client-id" name="clientId" placeholder="Enter your Spotify Client ID">
                        </div>
                        
                        <div class="form-group">
                            <label for="client-secret">Client Secret</label>
                            <input type="password" id="client-secret" name="clientSecret" placeholder="Enter your Spotify Client Secret">
                        </div>
                        
                        <div class="form-group">
                            <label for="refresh-token">Refresh Token</label>
                            <input type="text" id="refresh-token" name="refreshToken" placeholder="Enter your Spotify Refresh Token">
                        </div>
                        
                        <button type="submit">Save Configuration</button>
                    </form>
                    
                    <div class="status" style="margin-top: 15px; display: none;" id="config-status-container">
                        <div class="status-indicator" id="config-indicator"></div>
                        <div class="status-message" id="config-status"></div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="homepage-tab">
                <div class="card">
                    <h2>Homepage Widget Configuration</h2>
                    <p>Add the following configuration to your Homepage <code>services.yaml</code> file:</p>
                    
                    <div class="homepage-config" id="homepage-config">
# Loading configuration...
                    </div>
                    
                    <button id="copy-config" style="margin-top: 15px;">Copy to Clipboard</button>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Spotify Proxy for Homepage v1.0.0</p>
        </div>
    </div>
    
    <script>
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Add active class to clicked tab
                tab.classList.add('active');
                
                // Show corresponding content
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                
                // Fill form fields
                document.getElementById('client-id').value = config.clientId || '';
                document.getElementById('client-secret').value = '';  // Don't show the secret
                document.getElementById('refresh-token').value = config.refreshToken ? config.refreshToken.substring(0, 10) + '...' : '';
                
                // Update status indicators
                updateStatusIndicator(config.status);
                
                // Update last API call
                if (config.lastApiCall) {
                    document.getElementById('last-api-call').textContent = `Last API Call: ${new Date(config.lastApiCall).toLocaleString()}`;
                }
                
                // Update currently playing if available
                if (config.lastPlaying) {
                    updateNowPlaying(config.lastPlaying);
                }
                
                // Generate Homepage config
                const serverUrl = window.location.origin;
                const homepageConfig = `- name: "Spotify"
  icon: spotify
  href: https://open.spotify.com
  description: Music Controls
  widget:
    type: customapi
    url: ${serverUrl}/currently-playing
    refreshInterval: 5000
    method: GET
    mappings:
      - field: item.name
        label: Track
      - field: item.artists.0.name
        label: Artist
      - field: item.album.name
        label: Album
      - field: is_playing
        label: Status
        format: text
      - field: progress_ms
        label: Progress
        format: duration
      - field: item.duration_ms
        label: Duration
        format: duration
  actions:
    - name: Previous
      icon: skip-backward
      url: ${serverUrl}/previous
      method: POST
    - name: Play/Pause
      icon: play-pause
      url: ${serverUrl}/{{is_playing ? 'pause' : 'play'}}
      method: POST
    - name: Next
      icon: skip-forward
      url: ${serverUrl}/next
      method: POST`;
                
                document.getElementById('homepage-config').textContent = homepageConfig;
            } catch (error) {
                console.error('Error loading config:', error);
                updateConnectionStatus(false, 'Error loading configuration');
            }
        }
        
        // Update status indicator
        function updateStatusIndicator(status) {
            const connectionIndicator = document.getElementById('connection-indicator');
            const connectionStatus = document.getElementById('connection-status');
            const apiIndicator = document.getElementById('api-indicator');
            const apiStatus = document.getElementById('api-status');
            
            if (status) {
                apiIndicator.className = 'status-indicator ' + (status.success ? 'status-success' : 'status-error');
                apiStatus.textContent = status.message || 'Unknown status';
            }
        }
        
        // Update connection status
        function updateConnectionStatus(success, message) {
            const connectionIndicator = document.getElementById('connection-indicator');
            const connectionStatus = document.getElementById('connection-status');
            
            connectionIndicator.className = 'status-indicator ' + (success ? 'status-success' : 'status-error');
            connectionStatus.textContent = message || (success ? 'Connected' : 'Disconnected');
        }
        
        // Update now playing information
        function updateNowPlaying(data) {
            if (!data || !data.item) {
                document.getElementById('now-playing-container').style.display = 'none';
                return;
            }
            
            document.getElementById('now-playing-container').style.display = 'block';
            document.getElementById('track-name').textContent = data.item.name || 'Unknown Track';
            
            const artists = data.item.artists ? data.item.artists.map(a => a.name).join(', ') : 'Unknown Artist';
            document.getElementById('artist-name').textContent = artists;
            
            if (data.item.album && data.item.album.images && data.item.album.images.length > 0) {
                document.getElementById('album-art').src = data.item.album.images[0].url;
            } else {
                document.getElementById('album-art').src = 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Spotify_icon.svg/1982px-Spotify_icon.svg.png';
            }
            
            // Update play/pause button
            document.getElementById('play-pause-button').textContent = data.is_playing ? '⏸' : '▶';
        }
        
        // Test connection
        document.getElementById('test-connection').addEventListener('click', async () => {
            try {
                updateConnectionStatus(null, 'Testing connection...');
                const response = await fetch('/api/test-connection');
                const data = await response.json();
                
                if (data.success) {
                    updateConnectionStatus(true, `Connected as ${data.user || 'Unknown User'}`);
                    
                    // Fetch currently playing
                    try {
                        const playingResponse = await fetch('/currently-playing');
                        const playingData = await playingResponse.json();
                        updateNowPlaying(playingData);
                    } catch (error) {
                        console.error('Error fetching currently playing:', error);
                    }
                } else {
                    updateConnectionStatus(false, data.error || 'Connection failed');
                }
            } catch (error) {
                console.error('Error testing connection:', error);
                updateConnectionStatus(false, 'Connection failed');
            }
        });
        
        // Save configuration
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const statusContainer = document.getElementById('config-status-container');
            const statusIndicator = document.getElementById('config-indicator');
            const statusMessage = document.getElementById('config-status');
            
            statusContainer.style.display = 'flex';
            statusIndicator.className = 'status-indicator';
            statusMessage.textContent = 'Saving configuration...';
            
            const formData = new FormData(e.target);
            const config = {
                clientId: formData.get('clientId'),
                clientSecret: formData.get('clientSecret'),
                refreshToken: formData.get('refreshToken')
            };
            
            // Only include fields that are not empty
            Object.keys(config).forEach(key => {
                if (!config[key] || config[key].includes('...')) {
                    delete config[key];
                }
            });
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusIndicator.className = 'status-indicator status-success';
                    statusMessage.textContent = 'Configuration saved successfully';
                    
                    // Reload config after a short delay
                    setTimeout(loadConfig, 1000);
                } else {
                    statusIndicator.className = 'status-indicator status-error';
                    statusMessage.textContent = data.message || 'Failed to save configuration';
                }
            } catch (error) {
                console.error('Error saving config:', error);
                statusIndicator.className = 'status-indicator status-error';
                statusMessage.textContent = 'Error saving configuration';
            }
        });
        
        // Copy Homepage config to clipboard
        document.getElementById('copy-config').addEventListener('click', () => {
            const configText = document.getElementById('homepage-config').textContent;
            navigator.clipboard.writeText(configText).then(() => {
                const button = document.getElementById('copy-config');
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            });
        });
        
        // Playback controls
        document.getElementById('play-pause-button').addEventListener('click', async () => {
            try {
                const isPlaying = document.getElementById('play-pause-button').textContent === '⏸';
                const endpoint = isPlaying ? '/pause' : '/play';
                
                await fetch(endpoint, { method: 'POST' });
                
                // Update button immediately for better UX
                document.getElementById('play-pause-button').textContent = isPlaying ? '▶' : '⏸';
                
                // Refresh now playing after a short delay
                setTimeout(async () => {
                    try {
                        const response = await fetch('/currently-playing');
                        const data = await response.json();
                        updateNowPlaying(data);
                    } catch (error) {
                        console.error('Error refreshing now playing:', error);
                    }
                }, 500);
            } catch (error) {
                console.error('Error controlling playback:', error);
            }
        });
        
        document.getElementById('next-button').addEventListener('click', async () => {
            try {
                await fetch('/next', { method: 'POST' });
                
                // Refresh now playing after a short delay
                setTimeout(async () => {
                    try {
                        const response = await fetch('/currently-playing');
                        const data = await response.json();
                        updateNowPlaying(data);
                    } catch (error) {
                        console.error('Error refreshing now playing:', error);
                    }
                }, 500);
            } catch (error) {
                console.error('Error skipping to next track:', error);
            }
        });
        
        document.getElementById('prev-button').addEventListener('click', async () => {
            try {
                await fetch('/previous', { method: 'POST' });
                
                // Refresh now playing after a short delay
                setTimeout(async () => {
                    try {
                        const response = await fetch('/currently-playing');
                        const data = await response.json();
                        updateNowPlaying(data);
                    } catch (error) {
                        console.error('Error refreshing now playing:', error);
                    }
                }, 500);
            } catch (error) {
                console.error('Error skipping to previous track:', error);
            }
        });
        
        // Load config on page load
        window.addEventListener('load', loadConfig);
        
        // Auto-refresh status every 30 seconds
        setInterval(loadConfig, 30000);
    </script>
</body>
</html>
